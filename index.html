<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quarter Search Application</title>
<style>
/* Define CSS variables for easier layout management */
:root {
	--fixed-header-height: 120px; 
    --max-content-width: 650px; 
    --slidebar-width: 250px;
    --toggle-width: 40px;
}

/* Global Reset: Ensure no default browser margins cause gaps */
body {
    margin: 0;
    padding: 0;
}

/* --- ANIMATION KEYFRAMES for Opening Nudge (Arrow points right, nudges right) --- */
@keyframes nudge-open {
    0%, 100% { 
        transform: translateX(0); 
    }
    50% { 
        transform: translateX(3px); /* Nudge 3px to the right */
    }
}

/* --- ANIMATION KEYFRAMES for Closing Nudge (Arrow points left, nudges left) --- */
@keyframes nudge-close {
    0%, 100% { 
        /* Start/end with the 180 degree rotation and no lateral shift */
        transform: rotate(180deg) translateX(0); 
    }
    50% { 
        /* Nudge 3px to the left, maintaining the 180 degree rotation */
        transform: rotate(180deg) translateX(-3px); 
    }
}


/* --- Base & Layout Styles --- */
body {
	font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	background: #f0f2f5;
	padding: 0 20px 20px 20px;
	min-height: 200vh;
}

/* --- Tiers 1 & 2 Sticky Group (PERMANENTLY fixed) --- */
.sticky-header-group-outer {
	max-width: var(--max-content-width);
	margin: 0 auto;
	position: fixed;
	top: 0;
	left: 50%;
	transform: translateX(-50%);
	width: calc(100% - 40px);
	box-sizing: border-box;
	z-index: 100; /* Fixed Header Z-index */
	background: #fff;
	border-top-left-radius: 12px;
	border-top-right-radius: 12px;
	overflow: hidden;
	box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
	-webkit-backface-visibility: hidden;
	backface-visibility: hidden;
	will-change: transform;
}

/* --- TIER 1: Title Bar (Royal Blue) --- */
.header-title-bar {
	background: #4169E1; /* Royal Blue */
	color: white;
	padding: 15px 20px;
	display: flex;
	justify-content: center;
	align-items: center;
}

.header-title-text {
	font-size: 20px;
	font-weight: 700;
	text-transform: uppercase;
	letter-spacing: 1px;
	text-align: center;
	flex-grow: 0;
}

/* --- TIER 2: Counters Section (Summary Bar: Total/Vacant/Occupied) */
.summary-counters-bar {
	display: flex;
	/* Ensures all counters take up equal width */
	justify-content: space-around; 
	gap: 10px;
	padding: 8px 25px; 
	background: #fff;
}

/* --- SLIDEBAR (Tier 3 Sidebar) --- */
.slidebar-overlay {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.5);
	z-index: 900;
	opacity: 0;
	visibility: hidden;
	transition: opacity 0.3s;
}
.slidebar-overlay.active {
	opacity: 1;
	visibility: visible;
}

/* --- SLIDEBAR GROUP: Contains Panel + Toggle (Slides together) --- */
.slidebar-group {
    position: fixed;
	top: var(--fixed-header-height); /* Start below the fixed header on desktop/mobile */
	
	/* Anchor the group to the left edge of the main content area (650px wide) */
	left: 50%; 
	margin-left: calc(-1 * (var(--max-content-width) / 2)); 
	
	width: calc(var(--slidebar-width) + var(--toggle-width)); 
	height: calc(100vh - var(--fixed-header-height)); 
	z-index: 1000; 
	
	/* Default HIDDEN state: Hides the panel off-screen, but leaves the toggle visible (40px) */
	transform: translateX(calc(-1 * var(--slidebar-width))); 
	transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    
    display: flex; /* Panel + Toggle side-by-side */
}
.slidebar-group.active {
	transform: translateX(0); /* Slides panel completely into view */
}

/* --- SLIDEBAR PANEL (The content) --- */
.slidebar-panel {
    width: var(--slidebar-width); 
    height: 100%; 
	background: white;
	box-shadow: 5px 0 20px rgba(0,0,0,0.15); 
	padding: 20px;
	box-sizing: border-box;
	overflow-y: auto;
	border-bottom-right-radius: 12px;
    flex-shrink: 0;
}

/* Style for the button attached to the sliding panel */
#sidebar-toggle {
    /* Button is part of the sliding group, positioned right of the panel */
    position: relative; 
    left: 0;
    top: 0;
    
	background: #28A745; /* Arrow background green */
	border: none;
	width: var(--toggle-width); 
	height: var(--toggle-width); 
	padding: 0; 
	border-radius: 0 8px 8px 0; /* Only right corners rounded */
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); 
	cursor: pointer;
	transition: background 0.2s, opacity 0.2s;
	display: flex; 
	justify-content: center;
	align-items: center;
	line-height: 1;
    
    /* === FIX: Increased vertical offset for better desktop positioning === */
    margin-top: 220px; 
    
    flex-shrink: 0;
    
    /* FIX: Z-index of 1001 ensures the arrow is on top of the fixed header (100) and the sticky table header (99) */
    z-index: 1001; 
}
#sidebar-toggle:hover {
	background: #1e7e34; /* Darker green on hover */
}

/* Arrow Icon Styling (SVG container) */
#toggle-icon {
	display: inline-block;
    /* Transition is crucial for a smooth flip during toggle */
	transition: transform 0.3s ease-in-out; 
	line-height: 1;
}

/* 1. Closed state: Apply nudge-open animation (Arrow points right, nudges right) */
.slidebar-group:not(.active) #toggle-icon {
    animation: nudge-open 1.5s infinite ease-in-out;
    /* Ensure no rotation is applied by default */
    transform: translateX(0);
}

/* 2. Open state: Apply nudge-close animation (Arrow points left, nudges left) */
.slidebar-group.active #toggle-icon {
    animation: nudge-close 1.5s infinite ease-in-out;
}

/* Style for the SVG arrow inside the button */
#toggle-icon svg {
    display: block;
    stroke: white; /* Arrow color to white */
    width: 18px; 
    height: 18px;
    position: static;
}

/* The 'rotated' class is kept for smooth transition fallback */
#toggle-icon.rotated {
    transform: rotate(180deg);
}


.slidebar-header {
	display: flex;
	justify-content: center; 
	align-items: center;
	margin-bottom: 25px;
	border-bottom: 2px solid #f0f2f5;
	padding-bottom: 10px;
}
.slidebar-title {
	font-size: 18px;
	font-weight: 800;
	color: #333;
	text-transform: uppercase;
}

/* --- SLIDEBAR PANEL CONTENT (Tier 3 Counters) --- */
.slidebar-content {
    /* Use flex container for consistent vertical spacing (Gap) */
    display: flex;
    flex-direction: column;
    gap: 12px; /* Set the gap/spacing between counters (12px) */
}

/* --- CONTENT WRAPPER: Shifts when the sidebar is open --- */
#content-wrapper {
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}
#content-wrapper.shifted {
    /* Shifts the main content to the right by the width of the slidebar panel */
    transform: translateX(var(--slidebar-width)); 
}


/* --- Filter Card Wrapper --- */
.sticky-filter-wrapper {
	max-width: var(--max-content-width);
	margin: 0 auto;
	/* Ensures the content starts exactly where the fixed header ends */
	margin-top: var(--fixed-header-height);
}

/* --- App Container --- */
.app-container {
	background: #ffffff;
	padding: 25px;
	border-radius: 12px;
	box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
	position: relative; 
	z-index: 5; 
    margin-bottom: 15px;
}

/* Filter Card Header and Title Styling */
.filter-header {
	display: flex;
	justify-content: center; 
	align-items: center;
	margin-bottom: 15px;
	padding-bottom: 10px;
	border-bottom: 1px solid #e0e0e0;
    padding-left: 0; 
}
.filter-title {
	font-size: 1.25rem;
	font-weight: 700;
	color: #333;
}


/* --- General Input Styles --- */
label {
	display: block;
	margin: 15px 0 5px;
	font-size: 14px;
	color: #444;
	font-weight: 600;
}
select, input[type="text"] {
	width: 100%;
	padding: 12px 10px;
	margin-bottom: 15px;
	border-radius: 8px;
	border: 1px solid #ccc;
	background: #fff;
	font-size: 16px;
	transition: border-color 0.3s;
}
select:focus, input[type="text"]:focus {
	border-color: #007bff;
	outline: none;
}
select:disabled {
	background-color: #f7f7f7;
	color: #999;
	cursor: not-allowed;
}

/* --- Summary Box Styles --- */
.summary-box {
	/* The flex-grow ensures the counters take up available space equally */
	flex-grow: 1;
	/* Ensures all counters are rendered identically in size */
	flex-basis: 0; 
	
	display: flex;
	flex-direction: column; /* Stack label and value vertically */
	justify-content: center; /* Center vertically */
	align-items: center; /* Center horizontally */
	
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	border-radius: 18px; 
}

/* Tier 2 Colors */
.summary-box.blue-summary { background: #4169E1; color: white; }
.summary-box.red-summary { background: #DC3545; color: white; }
.summary-box.green-summary { background: #28A745; color: white; }

/* ------------------------------------------------------------------ */
/* --- TIER 3 Specific Overrides (Slidebar Counters: Size, Shape, Gap) --- */
/* ------------------------------------------------------------------ */
.slidebar-content .summary-box {
    /* Shape: Larger, more modern rounded corners */
    border-radius: 16px; 
    /* Size: Increased padding for a larger target */
    padding: 16px 20px;
    
    /* Layout: Row to display label/value side-by-side */
    flex-direction: row; 
    justify-content: space-between;
    align-items: center;
    
    /* Add subtle shadow for depth (optional but nice) */
    box-shadow: 0 2px 5px rgba(33, 33, 33, 0.1); 
    
    /* Ensure no margins are interfering with the parent's gap */
    margin: 0; 
}

/* Tier 3 Colors */
.summary-box.oh-summary { background: #D4EDBC; color: #14532d; } 
.summary-box.onh-summary { background: #D4EDBC; color: #14532d; } 
.summary-box.vh-summary { 
    background: #FFCFC9; 
    color: #A00000; 
} 
.summary-box.vnh-summary { 
    background: #FFCFC9; 
    color: #A00000; 
} 

/* Values - Generic Styles */
.summary-label { font-weight: 600; line-height: 1.1;}
.summary-value { font-weight: 900; }

/* Tier 3 Label and Value Size */
.slidebar-content .summary-label { 
    font-size: 14px; 
    font-weight: 700;
}
.slidebar-content .summary-value { 
    font-size: 24px; 
    font-weight: 900; 
}

/* ------------------------------------------------------------------ */
/* --- TIER 2 Specific Overrides (Smaller Size, Small Rounded Corners, Centered Text) --- */
/* ------------------------------------------------------------------ */
.summary-counters-bar .summary-box {
    /* 1. Small rounded corners (e.g., 10px) */
    border-radius: 10px; 
    /* 2. Smaller minimum height */
    min-height: 65px; 
    /* 3. Ensure content is vertically and horizontally centered */
    justify-content: center; 
    align-items: center;
    text-align: center;
    /* Reduced padding */
    padding: 5px 10px; 
}

/* Tier 2 Label (Heading) Styling - Adjusted for smaller size */
.summary-counters-bar .summary-label { 
    font-size: 12px; /* Reduced from 14px */
    font-weight: 800; 
    line-height: 1.2;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Tier 2 Value Styling - Adjusted for smaller size */
.summary-counters-bar .summary-value { 
    font-size: 24px; /* Reduced from 28px */
    font-weight: 900; 
}


button.action-btn {
	display: block;
	width: 100%;
	padding: 14px;
	border-radius: 8px;
	border: 0;
	background: #000000;
	color: #fff;
	font-weight: 700;
	cursor: pointer;
	margin-top: 20px;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	transition: background 0.2s, opacity 0.2s;
}

button.action-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* --- Results Table --- */
#results { 
    max-width: var(--max-content-width); 
    margin: 0 auto; 
    /* Ensure no padding on the container that holds the table */
    padding: 0;
}

.results-table {
    /* Use display: block on the wrapper to allow position: sticky to work reliably */
	display: grid;
    /* This ensures the grid itself spans the container width */
    width: 100%;
	grid-template-columns: 1.2fr 1.2fr 1fr 1fr 1fr 1fr 1fr 1fr;
	gap: 1px;
	background-color: #e0e0e0;
	border-radius: 10px;
	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
}

/* Table Header (Sticky) Alignment and Z-index Fix */
.table-header {
	grid-column: 1 / -1; /* Span all columns in the grid */
	display: grid;
	grid-template-columns: 1.2fr 1.2fr 1fr 1fr 1fr 1fr 1fr 1fr;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
	position: sticky;
    
    /* KEY FIX: Position the sticky header exactly at the bottom of the fixed header group */
	top: var(--fixed-header-height);
    
	background-color: #4169E1;
	
    /* FIX: Decreased z-index to 99 so it sticks UNDER the fixed header (100) and the toggle (1001) */
	z-index: 99;
    
    /* KEY FIX: Explicitly setting width to 100% when sticky to prevent collapse */
    width: 100%; 
    /* Overwrite grid-gap within the header itself */
    gap: 0; 
}
.table-row { display: contents; }
.table-cell {
	padding: 12px 8px;
	font-size: 13px;
	text-align: center;
	background-color: #fff;
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
}
.header-cell {
	color: white;
	background-color: #4169E1;
	font-weight: 700;
	text-transform: uppercase;
	padding: 15px 8px;
	font-size: 12px;
	position: relative;
	/* The individual header cells need the lower z-index too */
	z-index: 100; 
	border-right: 2px solid #4169E1;
}
/* Apply corner radius to the header cells based on the table's container radius */
.table-header .header-cell:first-child { border-top-left-radius: 10px; }
.table-header .header-cell:last-child { border-top-right-radius: 10px; border-right: none; }
.status-occupied { background-color: #e6ffe6; color: #28a745; font-weight: 600;}
.status-vacant { background-color: #ffeded; color: #dc3545; font-weight: 600;}
.table-row:nth-child(even) .table-cell { background-color: #f8f9fa; }
.table-row:nth-child(even) .status-occupied { background-color: #e0f8e0; }
.table-row:nth-child(even) .status-vacant { background-color: #feebe9; }

/* Mobile Adaptations (Responsive View) */
@media (max-width: 680px) {
    /* FIX: REDEFINE FIXED HEADER HEIGHT FOR MOBILE */
    :root {
        --fixed-header-height: 160px; 
    }
    
	/* General Layout */
	body { padding: 0 0 15px 0; }
	.sticky-header-group-outer { 
        width: 100%; 
        border-radius: 0; 
        /* Ensure the fixed element uses the full width */
        left: 0; 
        transform: none;
    }
	.header-title-text { font-size: 18px; }
	
    /* TIER 2 COUNTER ADJUSTMENTS FOR MOBILE */
	.summary-counters-bar { 
        padding: 15px 8px; 
        gap: 5px; 
    } 
    .summary-counters-bar .summary-box {
        min-height: 60px; /* Smaller height on mobile */
        padding: 6px 10px; 
    }
    .summary-counters-bar .summary-label { 
        font-size: 11px; /* Smaller font on mobile */
    } 
    .summary-counters-bar .summary-value { 
        font-size: 20px; /* Smaller font on mobile */
    } 

	.sticky-filter-wrapper, #results { max-width: none; }
	
    /* Content wrapper margin starts exactly where the FIXED header ends */
    .sticky-filter-wrapper { 
        margin-top: var(--fixed-header-height); 
        padding: 0 15px;
    }

	.results-table { border-radius: 8px; }
	
	/* Results Table Compression */
	.table-cell { font-size: 10px; padding: 6px 3px; }
	.header-cell { font-size: 9px; padding: 8px 3px; border-right: 1px solid #4169E1;}
	
    /* === NEW FIX: Override sticky table header position for mobile === */
    /* Moves the header down 20px further (160px + 20px = 180px) */
    .table-header {
        top: 180px; 
    }
    
	/* --- SIDEBAR FIXES FOR MOBILE CLICKABILITY AND VISIBILITY --- */
	.slidebar-group {
        /* FIX 1: Anchor the sidebar group *below* the fixed header (160px) */
        top: var(--fixed-header-height); 
        height: calc(100vh - var(--fixed-header-height));
		left: 0; 
		margin-left: 0;
        transform: translateX(calc(-1 * var(--slidebar-width)));
	}
    
    /* FIX 2: Reduce the margin-top to position the toggle just below the sticky header when locked */
    #sidebar-toggle {
        margin-top: 60px; 
        cursor: pointer;
    }
    
    /* Mobile Content Shift */
    #content-wrapper.shifted {
        transform: translateX(var(--slidebar-width)); 
    }
}

.empty{padding:20px;background:#fff;border-radius:10px;border:1px dashed #e0e0e0;text-align:center;color:#888; margin-top: 25px;}
</style>
</head>
<body>

<!-- Slidebar Overlay -->
<div class="slidebar-overlay" id="overlay" onclick="toggleSlidebar()"></div>

<!-- Slidebar Group (Panel + Toggle) - This entire block slides -->
<div class="slidebar-group" id="slidebar-group">
    <!-- Slidebar Panel (Tier 3) -->
    <div class="slidebar-panel" id="slidebar">
        <div class="slidebar-header">
            <div class="slidebar-title">Detailed Breakdown</div>
        </div>
        <div class="slidebar-content">
            <!-- P4: Occupied Habitable -->
            <div id="p4-count" class="summary-box oh-summary">
                <div class="summary-label">OCCUPIED HABITABLE</div>
                <div id="p4-value" class="summary-value">0</div> 
            </div>
            <!-- Q4: Occupied Non-Habitable -->
            <div id="q4-count" class="summary-box onh-summary">
                <div class="summary-label">OCCUPIED NON-HABITABLE</div>
                <div id="q4-value" class="summary-value">0</div>
            </div>
            <!-- R4: Vacant Habitable -->
            <div id="r4-count" class="summary-box vh-summary">
                <div class="summary-label">VACANT HABITABLE</div>
                <div id="r4-value" class="summary-value">0</div>
            </div>
            <!-- S4: Vacant Non-Habitable -->
            <div id="s4-count" class="summary-box vnh-summary">
                <div class="summary-label">VACANT NON-HABITABLE</div>
                <div id="s4-value" class="summary-value">0</div>
            </div>
        </div>
    </div>
    
    <!-- The toggle button/handle is now attached to the sliding panel, acting as the handle -->
    <button id="sidebar-toggle" onclick="toggleSlidebar()">
        <span id="toggle-icon">
            <!-- Default state: points right (to open the panel) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/>
                <path d="m12 5 7 7-7 7"/>
            </svg>
        </span>
    </button>
</div>

<!-- Sticky Header (Tiers 1 & 2) -->
<div class="sticky-header-group-outer">
	<div class="sticky-header-group">
		<!-- TIER 1 -->
		<div class="header-title-bar">
			<div class="header-title-text">SOLAPUR DIVISION QUARTER SEARCH</div>
		</div>
		<!-- TIER 2 -->
		<div class="summary-counters-bar">
			<div id="total-count-container" class="summary-box blue-summary">
				<div class="summary-label">TOTAL</div>
				<div id="total-value" class="summary-value">0</div>
			</div>
			<div id="occupied-count" class="summary-box green-summary">
				<div class="summary-label">OCCUPIED</div>
				<div id="occupied-value" class="summary-value">0</div>
			</div>
			<div id="vacant-count" class="summary-box red-summary">
				<div class="summary-label">VACANT</div>
				<div id="vacant-value" class="summary-value">0</div>
			</div>
		</div>
	</div>
</div>

<!-- Main Content Wrapper - Shifts when the sidebar is open -->
<main id="content-wrapper">

    <!-- Filters -->
    <div class="sticky-filter-wrapper">
        <div class="app-container">
            
            <!-- Filter Card Header with centered Title -->
            <div class="filter-header">
                <h2 class="filter-title">Filter Quarters</h2>
            </div>

            <label for="station">Station</label>
            <select id="station" name="station"></select>
            
            <label for="colony">Colony</label>
            <select id="colony" name="colony" disabled></select>
            
            <label for="department">Department</label>
            <select id="department" name="department" disabled></select>
            
            <label for="building">Building</label>
            <select id="building" name="building" disabled></select>
            
            <label for="type">Type</label>
            <select id="type" name="type" disabled></select>
            
            <label for="number">Number</label>
            <select id="number" name="number" disabled></select>
            
            <label for="floor">Floor</label>
            <select id="floor" name="floor" disabled></select>
            
            <button class="action-btn" id="clear-button">CLEAR</button>

        </div>
    </div>

    <!-- Results -->
    <div id="results"></div>

</main>

<script type="module">
// --- Firebase and Canvas Environment Setup (Required by the environment) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Global variables provided by the Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Initialize Firebase services
let app;
let db;
let auth;

try {
    if (Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in using the provided token or anonymously
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
    }
} catch (error) {
    console.error('Firebase initialization or authentication failed:', error);
}

// --- Application Logic ---

// Toggle Sidebar Function
window.toggleSlidebar = function() {
	const sidebarGroup = document.getElementById('slidebar-group');
    const contentWrapper = document.getElementById('content-wrapper');
	const overlay = document.getElementById('overlay');
	const icon = document.getElementById('toggle-icon');

	// Toggle the active class on the sidebar group and content wrapper
	const isActive = sidebarGroup.classList.toggle('active');
    contentWrapper.classList.toggle('shifted');
	overlay.classList.toggle('active');

	// Toggle the 'rotated' class on the icon element
	if (icon) {
		icon.classList.toggle('rotated', isActive); 
	}
}

// NOTE: This is the external Google Sheet URL in CSV format.
const csvUrl = 'https://docs.google.com/spreadsheets/d/1ZuwyBdel75zj_FMJXHtOa4c5AG86W111YwvEQCje-KM/export?format=csv&gid=0';

// Column Indices in the Google Sheet (data starts from row 6, index 5)
const COL = {
	station:5, colony:6, department:7, building:8, type:9, number:10, floor:11, plinth:12, status:13,
	p4_flag: 15, // Occupied Habitable
	q4_flag: 16, // Occupied Non-Habitable
	r4_flag: 17, // Vacant Habitable
	s4_flag: 18 // Vacant Non-Habitable
};
const ORDER = ['station', 'colony', 'department', 'building', 'type', 'number', 'floor'];
let data = [];
let currentFilteredData = [];
let currentCounts = { total: 0, occupied: 0, vacant: 0, p4: 0, q4: 0, r4: 0, s4: 0 };


/**
 * Robust CSV parsing: Handles quotes/commas and skips the initial header rows (skips rows 1-5).
 */
function parseCSV(text) {
	text = text.replace(/\r/g, '');
	const lines = text.split('\n');
	const rows = [];
	// Regex to handle quoted fields containing commas
	const regex = /(?:"((?:[^"]|"")*)"|([^,]*))(?:,|$)/g;
	const MIN_COLS = COL.s4_flag;

	// Start parsing from row 6 (index 5)
	for (let i = 5; i < lines.length; i++) {
		const line = lines[i].trim();
		if (!line) continue;
		const row = [];
		let match;
		regex.lastIndex = 0;
		while ((match = regex.exec(line)) !== null) {
			if (match.index === regex.lastIndex) {
				if (regex.lastIndex < line.length) { regex.lastIndex++; } else { break; }
			}
			const raw = (match[1] !== undefined && match[1] !== null) ? match[1].replace(/""/g, '"') : match[2];
			row.push((raw !== undefined && raw !== null) ? raw.trim() : '');
			if (row.length > 30) break; // Safety break
		}
		// Ensure the row is long enough and contains some data
		if (row.length > MIN_COLS && row.some(cell => cell !== '')) {
			rows.push(row);
		}
	}
	return rows;
}

/**
 * Loads the CSV data, parses it, initializes the station filter, and updates the display.
 */
async function loadCSV() {
	try {
		const res = await fetch(csvUrl);
		if (!res.ok) throw new Error('HTTP ' + res.status);
		const txt = await res.text();
		const rows = parseCSV(txt);

		// Map raw data array to objects for easier access using column keys
		data = rows.map(r => ({
			station: r[COL.station] || '',
			colony: r[COL.colony] || '',
			department: r[COL.department] || '',
			building: r[COL.building] || '',
			type: r[COL.type] || '',
			number: r[COL.number] || '',
			floor: r[COL.floor] || '',
			plinth: r[COL.plinth] || '',
			status: r[COL.status] || '',
			p4_flag: r[COL.p4_flag] || '0',
			q4_flag: r[COL.q4_flag] || '0',
			r4_flag: r[COL.r4_flag] || '0',
			s4_flag: r[COL.s4_flag] || '0'
		}));

		const stations = getUniqueFilteredValues(data, 'station');
		populateDropdown('station', stations);
		document.getElementById('station').disabled = false;
		
		// Initial filter and update
		currentFilteredData = data.slice();
		updateSummaryCounters();
		showResults();

	} catch (err) {
		console.error('Failed to load CSV:', err);
		document.getElementById('results').innerHTML = '<div class="empty">Error loading sheet CSV. Please ensure the Google Sheet is published to web as CSV and the link is correct.</div>';
        
        // This is where the error originated, so we will safely initialize the counters to 0
        updateSummaryCounters(0); 
	}
}

/**
 * Fills a <select> element with unique values.
 */
function populateDropdown(id, items) {
	const sel = document.getElementById(id);
	const currentValue = sel.value;
	sel.innerHTML = '<option value="">-- Select --</option>';
	items.forEach(v => {
		const o = document.createElement('option');
		o.value = v;
		o.textContent = v;
		sel.appendChild(o);
	});
	if (items.includes(currentValue)) {
		sel.value = currentValue;
	} else {
		sel.value = '';
	}
	// Only disable if no items are available AND it's not the initial 'station' filter
	sel.disabled = items.length === 0 && id !== 'station';
}

/**
 * Checks if a flag value (P4, Q4, R4, S4) is considered 'active' (1 or Yes).
 */
function isFlagActive(flagValue) {
	const val = (flagValue || '').toString().trim().toLowerCase();
	return val === '1' || val === 'yes';
}

/**
 * Gets unique values for a column from a dataset.
 */
function getUniqueFilteredValues(dataset, colKey) {
	const values = dataset.map(r => (r[colKey]||'').trim());
	
    // FIX APPLIED HERE: Must use 'new Set' constructor
	let uniqueValues = Array.from(new Set(values.filter(Boolean)));
	
	// Sort case-insensitively
	uniqueValues.sort((a,b)=>a.localeCompare(b,'en',{sensitivity:'base'}));
	return uniqueValues;
}

/**
 * Updates all Tier 2 (Total, Vacant, Occupied) and Tier 3 (P4/Q4/R4/S4) summary counters.
 */
function updateSummaryCounters() {
	const subset = currentFilteredData; // Use the globally updated filtered data
	let vacantCount = 0;
	let occupiedCount = 0;
	let p4Count = 0, q4Count = 0, r4Count = 0, s4Count = 0;

	subset.forEach(r => {
		const status = (r.status || '').toLowerCase();
		const isVacant = status.includes('vacant');
		const isOccupied = status.includes('occupied');
		
		if (isVacant) vacantCount++;
		else if (isOccupied) occupiedCount++;
		
		// Tier 3 Flags (P4, Q4, R4, S4)
		if (isFlagActive(r.p4_flag)) p4Count++;
		if (isFlagActive(r.q4_flag)) q4Count++;
		if (isFlagActive(r.r4_flag)) r4Count++;
		if (isFlagActive(r.s4_flag)) s4Count++;
	});

	currentCounts = {
        vacant: vacantCount,
        occupied: occupiedCount,
        total: vacantCount + occupiedCount,
        p4: p4Count, q4: q4Count, r4: r4Count, s4: s4Count
    };

	// Tier 2 Update
	if(document.getElementById('total-value')) document.getElementById('total-value').textContent = currentCounts.total;
    if(document.getElementById('vacant-value')) document.getElementById('vacant-value').textContent = currentCounts.vacant;
    if(document.getElementById('occupied-value')) document.getElementById('occupied-value').textContent = currentCounts.occupied;

    // Tier 3 Slidebar Update
    if(document.getElementById('p4-value')) document.getElementById('p4-value').textContent = currentCounts.p4;
    if(document.getElementById('q4-value')) document.getElementById('q4-value').textContent = currentCounts.q4;
    if(document.getElementById('r4-value')) document.getElementById('r4-value').textContent = currentCounts.r4;
    if(document.getElementById('s4-value')) document.getElementById('s4-value').textContent = currentCounts.s4;
}

/**
 * Filters and populates the dropdowns that follow the currently changed dropdown.
 */
function filterNext(currentId) {
	const curIdx = ORDER.indexOf(currentId);
	const subset = getFilteredData();
	
	// Reset/repopulate subsequent dropdowns
	for (let i = curIdx + 1; i < ORDER.length; i++) {
		const nextId = ORDER[i];
		const nextEl = document.getElementById(nextId);
		if (nextEl) {
			const values = getUniqueFilteredValues(subset, nextId);
			populateDropdown(nextId, values);
			if(values.length === 0) {
				nextEl.value = '';
			}
		}
	}
	
	// Update counters and results based on new filters
	currentFilteredData = subset; // Update the global filtered data
	updateSummaryCounters();
	showResults();
}

/**
 * Gets the currently applied filters and returns the filtered data.
 */
function getFilteredData() {
    let filtered = data.slice();
    ORDER.forEach(key => {
        const value = document.getElementById(key)?.value;
        if (value) {
            filtered = filtered.filter(item => (item[key] || '').trim() === value);
        }
    });
    return filtered;
}

/**
 * Generates and displays the results table.
 */
function showResults() {
	const rows = currentFilteredData;
	const out = document.getElementById('results');
	out.innerHTML = '';
	
	if (!rows.length) {
		out.innerHTML = '<div class="empty">No matching records found for the selected criteria.</div>';
		return;
	}
	
	let html = '<div id="results-scroll-container"><div class="results-table">';
	
	// Table Header (Sticky)
	html += '<div class="table-header">';
	html += '<div class="table-cell header-cell">Station</div>';
	html += '<div class="table-cell header-cell">Colony</div>';
	html += '<div class="table-cell header-cell">Dept</div>';
	html += '<div class="table-cell header-cell">Building</div>';
	html += '<div class="table-cell header-cell">Type</div>';
	html += '<div class="table-cell header-cell">Number</div>';
	html += '<div class="table-cell header-cell">Floor</div>';
	html += '<div class="table-cell header-cell">Status</div>';
	html += '</div>';

	// Table Rows
	rows.forEach((r, index) => {
		const statusText = r.status || 'N/A';
		const isVacant = (statusText.toLowerCase().includes('vacant'));
		const rowClass = index % 2 === 0 ? 'even-row' : 'odd-row';
		const statusClass = isVacant ? 'status-vacant' : 'status-occupied';

		html += `<div class="table-row ${rowClass}">`;
		html += `<div class="table-cell">${r.station || '-'}</div>`;
		html += `<div class="table-cell">${r.colony || '-'}</div>`;
		html += `<div class="table-cell">${r.department || '-'}</div>`;
		html += `<div class="table-cell">${r.building || '-'}</div>`;
		html += `<div class="table-cell">${r.type || '-'}</div>`;
		html += `<div class="table-cell">${r.number || '-'}</div>`;
		html += `<div class="table-cell">${r.floor || '-'}</div>`;
		html += `<div class="table-cell ${statusClass}">${statusText}</div>`;
		html += '</div>';
	});
	html += '</div></div>';
	out.innerHTML = html;
}

/**
 * Resets all filters to their initial state.
 */
function clearAll() {
	// Reset all dropdowns except 'station' back to their default disabled state
	ORDER.forEach(id => {
		const sel = document.getElementById(id);
		if (sel) {
			sel.value = '';
			if (id !== 'station') {
				sel.innerHTML = '<option value="">-- Select --</option>';
				sel.disabled = true;
			}
		}
	});
	
	// Re-enable and repopulate the primary filter
	const stationEl = document.getElementById('station');
	if (stationEl) stationEl.disabled = false;
	const stations = getUniqueFilteredValues(data, 'station');
	populateDropdown('station', stations);
	
	// Initial filter and update
	currentFilteredData = data.slice();
	updateSummaryCounters();
	showResults();
}

/**
 * Wires up event listeners for filter changes and buttons.
 */
function wireEvents() {
	// Attach change listener to all filter dropdowns
	ORDER.forEach(id => {
		const el = document.getElementById(id);
		if (el) {
			el.addEventListener('change', () => filterNext(id));
		}
	});
	// Attach click listener to the clear button
	document.getElementById('clear-button').addEventListener('click', clearAll);
}

// Initialize the application
wireEvents();
loadCSV();
</script>

</body>
</html>
